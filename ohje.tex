\documentclass[12pt,a4paper]{scrartcl}
\usepackage[finnish]{babel}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{zref-lastpage,zref-user}
\usepackage{fancyhdr}
\frenchspacing
\lhead{Sukijan asennus- ja käyttöohje (Copyright © 2011--2013 Hannu Väisänen)}
\rhead{\thepage(\zpageref{LastPage})}
\cfoot{}
\begin{document}
\pagestyle{fancy}
\setlength{\parindent}{0pt}
\setlength{\parskip}{1ex plus 0.5ex minus 0.2ex}
\section*{Sukijan asennus- ja käyttöohje}

Sukija on Javalla kirjoitettu ohjelma suomenkielisten tekstien
indeksointiin.

Sukija analysoi sanat morfologisesti, muuttaa sanat perusmuotoon (joka
on sanakirjoissa) ja indeksoi perusmuodot, jotta sanan kaikki
taivutusmuodot löytyvät vain perusmuotoa etsimällä.

Sukija tallentaa perusmuodot Solr:n tietokantaan, josta niitä voi
etsiä Solr:n käyttöliittymän kautta.

Sukija osaa indeksoida kaikkia niitä tiedostomuotoja, joita Apache
Tika \\(http://tika.apache.org/) osaa lukea.

\subsection*{Mitä tarvitaan ja mistä ne saa?}

\begin{itemize}

\item Sukija:
      \verb=https://github.com/ahomansikka/sukija= \\
      Koska luet tätä tekstiä, olet jo imuroinut tämän. (-:

\item Suomi-Malaga Se on corevoikossa
      (\verb=https://github.com/voikko/corevoikko=) \\
      hakemistossa suomimalaga.

\item Apache Solr 4.6.0:
      \verb=http://lucene.apache.org/solr/=

\item Ubuntun paketit \verb=libmalaga7= ja \verb=maven=.
\end{itemize}

Lisäksi Sukija tarvitsee erinäisiä jar-tiedostoja, mutta Maven imuroi
ne verkosta automaagisesti.

Sukijaa voi käyttää myös Voikon Java-version kanssa. Tällöin tarvitaan
Ubuntun paketti  \verb=libvoikko1=.

Tämä asennusohje olettaaa, että corevoikko ja apache-solr ovat hakemistoissa \\
\verb=$HOME/Lataukset/corevoikko/= ja
\verb=$HOME/Lataukset/solr/solr-4.6.0=

Jos ne ovat jossain muualla, tiedoston \verb=Makefile= alussa olevia
muuttujia \verb=SOLR_HOME= ja \verb=JETTY_CONTEXTS_DIR= pitää muuttaa
vastaavasti.

\newpage
\subsection*{Ohjelman rakenne}

Sukijassa on kolme osaa:

\begin{itemize}
\item sukija-core     Java-luokkia, joita muut ohjelman osat tarvitsevat.
\item sukija-malaga   Solr:n liitännäinen, joka käyttää Suomi-Malagan
                      Sukija-versiota \\muuttamaan sanat perusmuotoon.
\item sukija-voikko   Solr:n liitännäinen, joka käyttää Voikkoa
                      muuttamaan sanat perusmuotoon.
\end{itemize}


\subsection*{Suomi-Malagan asentaminen}

Suomi-Malagasta on kaksi versiota, Voikko-versio on tarkoitettu
oikolukuun ja Sukija tiedostojen indeksointiin. Sukija-versio
käännetään komennolla

\begin{verbatim}
cd $HOME/Lataukset/corevoikko/suomimalaga
make sukija
\end{verbatim}

Tee alihakemisto \verb=$HOME/.sukija= ja kopioi sinne tiedostot \\
\verb=suomimalaga/sukija/{suomi.*_l,suomi.pro}=

Myös Voikko-versiota voi käyttää indeksointiin, kun sen kääntää ja
asentaa komennoilla

\begin{verbatim}
cd $HOME/Lataukset/corevoikko/suomimalaga
make voikko-sukija
make voikko-install DESTDIR=~/.voikko
\end{verbatim}

\verb|DESTDIR| voi olla myös joitan muuta kuin \verb|~/.voikko|.

Versioiden erot ovat siinä, että Sukija"-versio tunnistaa myös vanhoja
taivutusmuotoja ja sanoja sekä yleisiä kirjoitusvirheitä.


\subsection*{Sukijan kääntäminen ja asentaminen, Solr:n konfigurointi}

Ensin käännetään Sukija komennolla

\verb=mvn package=

Komento imuroi netistä tarvitsemansa Javan jar-paketit eli ensimmäinen
kääntäminen saattaa kestää kauan. Erityisen kauan se kestää, jos et
ole aiemmin käyttänyt mavenia.

Testien aikana tulee virheilmoitus

SLF4J: Class path contains multiple SLF4J bindings.

Siitä ei tarvitse välittää.

\bigskip Toisessa vaiheessa asetetaan Solr:n konfigurointitiedostoon
\verb=schema.xml= saneistajaluokka (ulkomaankielellä tokenizer), joka
lukee sanat tiedostoista, ja morfologialuokka, joka muuttaa sanat
perusmuotoon. Komennolla \verb|make ____-schema| on viisi eri
vaihtoehtoa:

\begin{tabular}{@{}ll}
Komento                              & Morfologialuokka \\
\verb=make malaga-schema=            & MalagaMorphologyFilterFactory \\
\verb=make malaga-suggestion-schema= & MalagaMorphologySuggestionFilterFactory \\
\verb=make voikko-schema=            & VoikkoMorphologyFilterFactory \\
\verb=make voikko-suggestion-schema= & VoikkoMorphologySuggestionFilterFactory \\
\verb=make debug-schema=             &
\end{tabular}

Komentoa \verb=make debug-schema= käytetään vain Sukijan
kehittämiseen.

Saneistajan oletusarvo on FinnishTokenizerFactory, joka tulee Sukijan
mukana, mutta sen voi vaihtaa muuttujalla TOKENIZER\_FACTORY
esimerkiksi näin:

\verb|make voikko-schema TOKENIZER_FACTORY=solr.StandardTokenizerFactory|

\verb=____FilterFactory= ja \verb=____SuggestionFilterFactory= eroavat
toisistaan siten, että jos morfologialuokka ei tunnista sanaa,
\verb=Suggestion="-luokissa sanaan tehdään muutoksia (esimerkiksi
muutetaan w v:ksi) ja tunnistusta yritetään uudestaan. Tämä ei ole
sama asia kuin Voikon oikeinkirjoituksen korjausehdotukset!

\verb=Suggestion="-luokat konfiguroidaan tiedostossa
\verb|suggestion.txt|. Katso sivu \zpageref{suggestionConfiguration}.

\bigskip
Indeksoitavat tiedostot asetetaan tiedostossa \verb|data-config.xml|.

Katso \\
\verb|http://wiki.apache.org/solr/DataImportHandler#FileListEntityProcessor| \\
ja
\verb|http://wiki.apache.org/solr/TikaEntityProcessor|.

Tärkeimmät konfiguroitavat parametrit ovat:

\begin{itemize}
\item baseDir
Hakemisto, jossa ja jonka alihakemistoissa tiedostot ovat.

\item fileName
Säännöllinen lauseke, joka valitsee indeksoitavat tiedostot.

\item excludes
Säännöllinen lauseke, joka valitsee tiedostot, joita ei indeksoida.
\end{itemize}

Komento \verb|make install| asettaa näiden oletusarvoiksi

baseDir \verb|$HOME/Asiakirjat|

fileName \verb|.*| eli kaikki tiedostot indeksoidaan.

excludes \\
{\footnotesize \verb+(?u)(?i).*[.](au|bmp|bz2|class|gif|gpg|gz|jar|jpg|jpeg|m|o|png|tif|tiff|wav|zip)$+}


Näitä voidaan muuttaa parametreilla \verb|BASE_DIR|,
\verb|FILE_NAME| ja
\verb|EXCLUDES|. Esimerkiksi

\verb|make install BASE_DIR=/usr/local/data|

Säännöllisten lausekkeiden syntaksi on sama kuin Javan luokassa \\
\verb=java.util.regex.Pattern=.

Indeksoitavien tiedostojen asettamisen lisäksi komento
\verb=make install= kopioi hakemistossa \verb=conf= olevat Solr:n ja
Sukijan tarvitsemat tiedostot oikeisiin paikkoihin.

Tiedostot
\verb=data-config.xml=,
\verb=suggestion.txt= ja
\verb=synonyms.txt=
kopioidaan hakemistoon \verb=$HOME/.sukija=
ja tiedostot
\verb=schema.xml=,
\verb=solrconfig.xml=, \\
\verb=sukija-context.xml=,
\verb=sukija.xsl= ja
alihakemisto \verb=velocity=
niihin hakemistoihin, joista Solr löytää ne.


\subsection*{Solr:n käynnistäminen}

\begin{verbatim}
cd $HOME/Lataukset/solr/solr-4.5.1/example
java -jar start.jar
\end{verbatim}

Jos Solr valittaa jna:sta, käynnistyskomento on

\begin{verbatim}
java -Djna.nosys=true -jar start.jar
\end{verbatim}

Solr:n käynnistymisen voi varmistaa selaimessa menemällä verkko-osoitteeseen

\verb|http://localhost:8983/solr/admin/|


\subsection*{Solr:n loki}

Solr:n lokitulostus (\verb=http://wiki.apache.org/solr/SolrLogging=)
konfiguroidaan tiedostossa
\verb=solr-4.5.1/example/resources/log4j.properties=
Mahdollisimman suuren lokitulostuksen saa lisäämällä tämän tiedoston
loppuun rivit

\begin{verbatim}
log4j.logger.peltomaa.sukija.finnish.HVTokenizer = ALL
log4j.logger.peltomaa.sukija.morphology.MorphologyFilter = ALL
log4j.logger.peltomaa.sukija.suggestion.Suggestion = ALL
log4j.logger.peltomaa.sukija.suggestion.SuccessFilter = ALL
log4j.logger.peltomaa.sukija.suggestion.SuggestionFilter = ALL
log4j.logger.peltomaa.sukija.malaga.MalagaMorphology = ALL
log4j.logger.peltomaa.sukija.voikko.VoikkoMorphology = ALL
\end{verbatim}

Tuossa ovat kaikki Sukijan luokat, joissa on lokitulostus.

Tällöin tulostus on paljon suurempi kuin indeksoitavat tiedostot (-:,
mutta kaikkia ei tietenkään tarvitse lisätä, riittää kun laittaa
luokat \verb=MorphologyFilter= sekä \\
\verb=SuggestionFilter= tai \verb=SuccessFilter=.

Luokkia \verb=SuggestionFilter= ja \verb=SuccessFilter= ei pidä
käyttää yhtaikaa.

Luokkaa \verb=HVTokenizer= ei tarvitse laittaa, jos ei käytä tätä
saneistajaa, ja luokkia \\
\verb=MalagaMorphology= ja \verb=VoikkoMorphology= Sukija ei käytä
yhtaikaa. \verb=SuggestionFilter= tuottaa lokitulostuksen kaikista
yrityksistä muuttaa sana perusmuotoon, \verb=Suggestion= kertoo
erikseen, mikä muunnos sai aikaan sanan tunnistamisen (katso sivu
\zpageref{suggestionConfiguration}).

Lokitulostuksen eri tasot (\verb=ALL=, jne) voi katsua luokan
\verb=org.apache.log4j.Level= dokumentoinnista.

Lokitulostus menee tiedostoon \verb=solr-4.5.1/example/logs/solr.log=


\subsection*{Indeksointi}

Tiedostot indeksoidaan menemällä osoitteeseen

\verb|http://localhost:8983/solr/dataimport?command=full-import|

Enemmän tai vähemmän pitkän ajan kuluttua indeksoinnin lopputuloksen
voi katsoa osoitteesta

\verb|http://localhost:8983/solr/dataimport|


\subsection*{Tietojen etsiminen}

Sanoja etsitään menemällä osoitteeseen
\verb=http://localhost:8983/solr/browse=

Etsittävien sanojen tulee olla perusmuodossa. Etsittäessä sanoja ei
muuteta perusmuotoon siksi, että yhden sanan perusmuoto voi olla
toisen sanan taivutusmuoto. Paras esimerkki tästä on ''alusta'', joka
on sanojen ''alusta'', ''alustaa'', ''alku'', ''alunen'' ja ''alus''
taivutusmuoto. Tällöin herää kysymys, mitä sanaa pitää etsiä, vai
etsitäänkö kaikkia?


Eri tavalla muotoillun tulostuksen saa osoitteesta \\
\verb=http://localhost:8983/solr/select=

Esimerkiksi sanaa \verb=sana= etsitään näin:

\verb|http://localhost:8983/solr/select?q=sana|

Tämän tulostuksen ulkonäköä voi muuttaa muuttamalla Sukijan mukana
tulevaa tiedostoa \verb=conf/sukija.xsl=.


\subsection*{Tiedoston suggestion.txt konfigurointi}
\zlabel{suggestionConfiguration}

Tiedosto \verb|suggestion.txt| pitää konfiguroida erikseen Sukijalle
ja Voikolle. Nykyinen konfiguraatio on tehty Sukijalle.

Tässä vaiheessa kaikki indeksoitavista tiedostoista luetut sanat on
muutettu pieniksi kirjaimiksi eli tiedostossa \verb|suggestion.txt|
olevat erisnimet pitää kirjoittaa pienellä alkukirjaimella.

Konfiguraatiossa on neljä komentoa. Komentojen nimet tulevat siitä,
että ne on toteutettu samannimisinä Java-luokkina tai ainakin melkein:
\verb|Apostrophe| on toteutettu luokassa \verb|ApostropheSuggestion|
ja niin edelleen.

\bigskip
\verb|Apostrophe| Poistaa sanasta heittomerkin ja yrittää tunnistaa
sanan sen jälkeen. Jos tunnistaminen ei onnistu, poistaa sanasta
heittomerkin ja kaikki sen jälkeiset merkit ja palauttaa jäljelle
jääneet merkit sanan perusmuotona. Esimerkiksi yrittää tunnistaa
merkkijonon \verb|centime'in| muodossa \verb|centimein|. Jos
tunnistaminen ei onnistu, palauttaa merkkijonon \verb|centime|.

\bigskip
\verb|Char| Muuttaa sanassa olevan yhden merkin toiseksi. Esimerkiksi

\verb|Char "w" "v"|

muuttaa w:t v:iksi (''wanha'' => ''vanha'').

\bigskip
\verb|CharCombination| Muuttaa yhden tai usemman merkin kaikki
kombinaatiot. Esimerkiksi

\verb|CharCombination "pk" "bg"|

(1) muuttaa p:t b:iksi, jättää k:t ennalleen,
(2) muuttaa k:t g:iksi, jättää p:t ennalleen, sekä
(3) muuttaa p:t b:iksi ja k:t g:iksi.

Siis jos tiedostosta luettu sana on ''piolokia'', komento yrittää
 tunnistaa sanat ''biolokia'', ''piologia'' ja ''biologia''.


\bigskip
\verb|Length3| poistaa kolmesta peräkkäisestä samasta kirjaimesta
yhden. \\ Esimerkiksi ''kauttta'' => ''kautta''.


\bigskip
\verb|Regex| muuttaa säännöllisen lausekkeen. Esimerkiksi

\verb|Regex "ai(j)[eou]" ""|

poistaa j"-kirjaimen muun muassa sanoista ''aijemmin'', ''aijomme'' ja
''kaijutin''.


Säännöllisessä lausekkeessa voi käyttää kirjainta \verb|C|
tarkoittamaan konsonantteja ja kirjainta \verb|V| tarkoittamaan
vokaaleja. Esimerkiksi

\verb|Regex  "C[ae](hi)C"  "i"|

poistaa h"-kirjaimet muun muassa sanoista ''ainahinen'' ja
''etehinen''.

Kirjaimia \verb|C| ja \verb|V| lukuun ottamatta säännöllisten
lausekkeiden syntaksi on sama kuin Javan luokassa
\verb=java.util.regex.Pattern=. Muita isoja kirjaimia ei tule
käyttää säännöllisissä lausekkeissa, koska tässä vaiheessa kaikki
tiedostoista luetut sanat on muutettu pieniksi kirjaimiksi, siis myös
isokirjaimiset lyhenteet ja erisnimien alkukirjaimet.

\bigskip
Näitä komentoja voi antaa mielivaltaisen paljon missä tahansa
järjestyksessä, ja \\ \verb|____SuggestionFilterFactory| palauttaa
perusmuotona ensimmäisen tunnistamansa muodon. Jos mitään ehdotusta ei
tunnisteta, \verb|____SuggestionFilterFactory| palauttaa alkuperäisen
merkkijonon.

Tiedostossa \verb|suggestion.txt| voi olla tyhjiä rivejä. Kommentti
alkaa merkillä \verb|#| ja jatkuu rivin loppuun.

\end{document}
